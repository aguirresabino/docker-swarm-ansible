---
- name: Apply common configuration to all nodes
  hosts: all
  become: true
  roles:
    - ntp
    - docker
    - python-requirements

- name: Initialize Docker Swarm on primary manager node
  hosts: primary_manager
  become: false
  vars:
    ansible_python_interpreter: >-
      {{ python_requirements_venv_path }}/bin/python
  roles:
    - docker-swarm-init

- name: Join additional managers to Docker Swarm
  hosts: managers:!primary_manager
  become: false
  vars:
    swarm_manager_token: >-
      {{ hostvars[groups['primary_manager'][0]]['manager_token'] }}
    swarm_primary_manager_host: >-
      {{ hostvars[groups['primary_manager'][0]]['ansible_host'] }}
    ansible_python_interpreter: >-
      {{ python_requirements_venv_path }}/bin/python
  tasks:
    - name: Include docker-swarm-manager role for additional managers
      ansible.builtin.include_role:
        name: docker-swarm-manager
      when: groups['managers'] | length > 1

- name: Join workers to Docker Swarm
  hosts: workers
  become: false
  vars:
    swarm_worker_token: >-
      {{ hostvars[groups['primary_manager'][0]]['worker_token'] }}
    swarm_primary_manager_host: >-
      {{ hostvars[groups['primary_manager'][0]]['ansible_host'] }}
    ansible_python_interpreter: >-
      {{ python_requirements_venv_path }}/bin/python
  tasks:
    - name: Include docker-swarm-worker role for worker nodes
      ansible.builtin.include_role:
        name: docker-swarm-worker
      when: groups['workers'] | length > 0
