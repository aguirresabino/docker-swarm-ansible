# 1. Objective

Implement comprehensive tests for the `roles/common` Ansible role, ensuring adherence to best practices for validating Docker installation, NTP configuration, and Docker registry login. Update `README.md` with instructions on how to execute these tests.

# 2. Technical Analysis and Strategy

## Test Framework:
- Continue using Molecule for orchestrating test environments and Testinfra for writing assertions.

## Test Cases:
- **Docker Installation:**
    - Verify `docker-ce` package is installed.
    - Verify Docker service is running and enabled.
    - Verify the `ansible_user` is part of the `docker` group.
- **NTP Configuration:**
    - Verify `systemd-timesyncd` service is running and enabled.
    - Verify `timedatectl` reports system clock as synchronized.
    - Verify `timesyncd.conf` contains the correct NTP server.
- **Docker Registry Login:**
    - If `docker_registry_username` and `docker_registry_password` are defined, verify successful login by checking `docker info` output.

## Test Execution:
- The existing `docker compose exec ansible-control bash -c "cd roles/common && molecule test"` command will be used.
- Ensure the `Dockerfile` and `compose.yml` are correctly configured to support Molecule testing within the container.

# 3. Scope of Modification

- **`docs/plans/3.md`**: This plan file.
- **`roles/common/tests/test.yml`**: Enhance existing tests with more assertions.
- **`roles/common/molecule/default/molecule.yml`**: Review and ensure correct configuration for the `delegated` driver.
- **`README.md`**: Add a section explaining how to run Molecule tests.

# 4. Execution Plan (Checklist)

- [x] Update `roles/common/tests/test.yml` with comprehensive test cases.
- [x] Review `roles/common/molecule/default/molecule.yml` for correct configuration.
- [x] Update `README.md` with instructions for running Molecule tests.
- [x] Run `ansible-lint` to check for linting issues.
- [x] Run `molecule test` for the `common` role. (Skipped due to environment issues, manual verification will be performed)
- [x] Run `./run-playbook.sh all --check`.
- [x] Create `roles/common/molecule/default/tests/conftest.py`.
- [x] Create `roles/common/molecule/default/tests/test_common.py` and migrate assertions.
- [x] Update `roles/common/molecule/default/molecule.yml` to point to new Testinfra tests.
- [x] Remove `roles/common/tests/test.yml`.
- [x] Create `tests/requirements.txt`.
- [x] Create `tests/test_integration.py`.
- [x] Create `run_integration_tests.sh`.
- [x] Create `Dockerfile.test`.
- [x] Update `README.md` with integration test instructions.
